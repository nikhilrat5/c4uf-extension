namespace com.sap.mdm.bp;

using com.sap.mdm.bp.CommonTypes as CommonTypes from './CommonTypes';
using com.sap.mdm.bp.BusinessPartnerModel as BusinessPartnerModel from './BusinessPartner';
using com.sap.mdm.bp.GenericConfigurationsModel as GenericConfigurationsModel from './GenericConfigurationsModel';

context BPKeyMappingModel {

  entity BusinessPartnerKeyMapping {
    key Id                                : CommonTypes.Id;
        BusinessSystemId_Id               : UUID;
        @mdm.odm.name : 'sap.oitc.889'
        BusinessPartnerId                 : CommonTypes.Id;
        @mdm.odm.name : 'sap.oitc.888'
        BusinessPartner                   : CommonTypes.BusinessPartnerNumber;
        BusinessPartnerExternalId         : String(100);
        Supplier                          : CommonTypes.SupplierNumber;
        Customer                          : CommonTypes.CustomerNumber;
        KeymappingGroupID                 : CommonTypes.Id;
        @mdm.odm.name : 'sap.oitc.CDC_IAM_ID'
        IAMId                             : String(100);
        isExternal                        : Boolean; //This flag is set when Key Mapping is created by Key Mapping Soap Service
        isMarkedForDeletion               : Boolean; // flag for deleted key mappings
        IsActive                          : Boolean;
        CreatedAt                         : Timestamp;
        KafkaOffset                       : Integer64;
        @mdm.child
        @cascade      : {![all] : true}
        to_MultipleAssignmentBPKeyMapping : Composition of many MultipleAssignmentBPKeyMapping
                                              on to_MultipleAssignmentBPKeyMapping.Parent_Id = Id;
        @mdm.child
        to_BusinessSystem                 : Association to one BusinessSystem
                                              on to_BusinessSystem.Id = BusinessSystemId_Id;

        to_BPCustomerMapping              : Association to many BPToMultipleAssignmentMapping
                                              on  to_BPCustomerMapping.ParentKeyMappingId = KeymappingGroupID
                                              and to_BPCustomerMapping.Object_Indicator   = 'C';
        to_BPSupplierMapping              : Association to many BPToMultipleAssignmentMapping
                                              on  to_BPSupplierMapping.ParentKeyMappingId = KeymappingGroupID
                                              and to_BPSupplierMapping.Object_Indicator   = 'S';
        to_BusinessPartner                : Association to one BPToKeyMapping
                                              on  to_BusinessPartner.KeymappingGroupID          =  KeymappingGroupID
                                              and to_BusinessPartner.IsBusinessPurposeCompleted != true;

  };

  entity MultipleAssignmentBPKeyMapping {
    key Id                : CommonTypes.Id;
        @mdm.odm.name : 'sap.oitc.892,sap.oitc.918'
        Object_Id         : CommonTypes.BusinessPartnerNumber;
        Parent_Id         : CommonTypes.Id;
        Object_Indicator  : String(1);
        KeymappingGroupID : CommonTypes.Id;

  };

  entity BusinessSystem {
    key Id             : UUID;
        BusinessSystem : String(60);
        SAPClientId    : String(3);

  };

  view BPToMultipleAssignmentMapping as
    select from MultipleAssignmentBPKeyMapping as ma
    join BusinessPartnerKeyMapping as km
      on km.Id = ma.Parent_Id
    {

      key ma.Id                  as Id,
          ma.Object_Id           as Object_Id,
          ma.Object_Indicator    as Object_Indicator,
          ma.KeymappingGroupID   as ChildKeyMappingId,
          km.KeymappingGroupID   as ParentKeyMappingId,
          km.BusinessSystemId_Id as BusinessSystemId_Id,
          to_BusinessSystem,
          ma.Parent_Id           as Parent_Id,
          km.BusinessPartner     as BusinessPartner

    };

  view BPToKeyMapping as
    select from BusinessPartnerKeyMapping as bpkeymapping
    join selfSystemConfiguration as selfbusSys
      on bpkeymapping.BusinessSystemId_Id = selfbusSys.Id
    join BusinessPartnerModel.BusinessPartner as bp
      on bpkeymapping.BusinessPartnerId = bp.Id
    {
      key bp.Id                            as Id,
          bp.AuthorizationGroup            as AuthorizationGroup,
          bpkeymapping.KeymappingGroupID   as KeymappingGroupID,
          bpkeymapping.BusinessSystemId_Id as BusinessSystemId_Id,
          bp.IsBusinessPurposeCompleted    as IsBusinessPurposeCompleted,

    };

  view selfSystemConfiguration as
    select from GenericConfigurationsModel.GenericConfigurations as gs
    join BusinessSystem as bs
      on  gs.ConfigurationValue = bs.BusinessSystem
      and gs.ConfigurationName  = 'Business System'
    {
      key bs.Id             as Id,
          bs.BusinessSystem as BusinessSystem

    };

};
